---
# ---------------------------------------------------------------------------
# troubleshooting / handlers / main.yml
# ---------------------------------------------------------------------------

- name: troubleshooting_send_notification
  listen: troubleshooting_send_notification
  ansible.builtin.uri:
    url: "{{ troubleshooting_slack_webhook_url }}"
    method: POST
    body_format: json
    body:
      text: >
        :mag: *Troubleshooting diagnostic completed* on `{{ inventory_hostname }}`
        at `{{ ansible_date_time.iso8601 }}`.
        Depth: `{{ troubleshooting_depth }}`.
        Artifacts staged at `{{ troubleshooting_artifact_dir }}`.
    status_code: [200]
  when: >
    troubleshooting_notify_on_finding is true and
    troubleshooting_slack_webhook_url | length > 0

- name: troubleshooting_cleanup_old_artifacts
  listen: troubleshooting_cleanup_old_artifacts
  ansible.builtin.find:
    paths: "{{ troubleshooting_artifact_dir }}"
    age: "{{ troubleshooting_artifact_retention_days }}d"
    state: file
  register: troubleshooting_old_files

- name: troubleshooting_remove_expired_artifacts
  listen: troubleshooting_cleanup_old_artifacts
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ troubleshooting_old_files.files | default([]) }}"
  loop_control:
    loop_var: item
