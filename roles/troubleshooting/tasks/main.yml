---
# ---------------------------------------------------------------------------
# troubleshooting / tasks / main.yml
# Entry-point task list.  Depth is governed by `troubleshooting_depth`.
# ---------------------------------------------------------------------------

- name: "[troubleshooting] Ensure artifact staging directory exists"
  ansible.builtin.file:
    path: "{{ troubleshooting_artifact_dir }}"
    state: directory
    mode: "0700"
    owner: root
    group: root

# ---------- basic checks (always run) ----------------------------------------
- name: "[troubleshooting] Capture service status for monitored services"
  ansible.builtin.service_facts:
  register: troubleshooting_service_facts

- name: "[troubleshooting] Write service-status snapshot"
  ansible.builtin.copy:
    content: "{{ troubleshooting_service_facts.ansible_facts.services | to_yaml }}"
    dest: "{{ troubleshooting_artifact_dir }}/service_status.yml"
    mode: "0600"

- name: "[troubleshooting] Capture disk and memory snapshot"
  ansible.builtin.shell:
    cmd: |
      echo "=== DISK ===" && df -Th &&
      echo "=== MEMORY ===" && free -m &&
      echo "=== SWAP ===" && swapon -s
  register: troubleshooting_disk_mem
  changed_when: false

- name: "[troubleshooting] Persist disk/memory snapshot"
  ansible.builtin.copy:
    content: "{{ troubleshooting_disk_mem.stdout }}"
    dest: "{{ troubleshooting_artifact_dir }}/disk_memory_snapshot.txt"
    mode: "0600"

# ---------- deep checks (conditional) ----------------------------------------
- name: "[troubleshooting] Deploy deep-scan helper script"
  ansible.builtin.copy:
    src: deep_scan.sh
    dest: "{{ troubleshooting_artifact_dir }}/deep_scan.sh"
    mode: "0750"
    owner: root
  when: troubleshooting_depth in ['deep', 'full']

- name: "[troubleshooting] Run deep port and lock scan"
  ansible.builtin.shell:
    cmd: "{{ troubleshooting_artifact_dir }}/deep_scan.sh"
  register: troubleshooting_deep_scan_output
  changed_when: false
  when: troubleshooting_depth in ['deep', 'full']

- name: "[troubleshooting] Persist deep-scan results"
  ansible.builtin.copy:
    content: "{{ troubleshooting_deep_scan_output.stdout }}"
    dest: "{{ troubleshooting_artifact_dir }}/deep_scan_results.txt"
    mode: "0600"
  when: troubleshooting_depth in ['deep', 'full']

# ---------- log scraping (always, but patterns expand at deep+) ---------------
- name: "[troubleshooting] Scrape configured log files for error patterns"
  ansible.builtin.shell:
    cmd: |
      for logfile in {{ troubleshooting_log_paths | join(' ') }}; do
        if [ -f "$logfile" ]; then
          echo ">>> $logfile <<<";
          grep -En '{{ troubleshooting_error_patterns | join("|") }}' "$logfile" | tail -200;
        fi
      done
  register: troubleshooting_log_scrape
  changed_when: false

- name: "[troubleshooting] Persist log-scrape findings"
  ansible.builtin.copy:
    content: "{{ troubleshooting_log_scrape.stdout }}"
    dest: "{{ troubleshooting_artifact_dir }}/log_scrape.txt"
    mode: "0600"

# ---------- full checks (thread-dump + network trace) ------------------------
- name: "[troubleshooting] Capture thread dump for Java processes"
  ansible.builtin.shell:
    cmd: |
      for pid in $(pgrep -f java); do
        echo "=== PID $pid ===";
        kill -3 "$pid" 2>/dev/null || true;
        sleep 1;
      done;
      cat /var/log/syslog | grep -A 100 "Full thread dump" | tail -500
  register: troubleshooting_thread_dump
  changed_when: false
  when: troubleshooting_depth == 'full'

- name: "[troubleshooting] Persist thread-dump output"
  ansible.builtin.copy:
    content: "{{ troubleshooting_thread_dump.stdout | default('No Java processes found') }}"
    dest: "{{ troubleshooting_artifact_dir }}/thread_dump.txt"
    mode: "0600"
  when: troubleshooting_depth == 'full'

- name: "[troubleshooting] Capture 5-second network trace (tcpdump)"
  ansible.builtin.shell:
    cmd: timeout 5 tcpdump -i any -c 500 -w {{ troubleshooting_artifact_dir }}/netcap.pcap || true
  changed_when: false
  when: troubleshooting_depth == 'full'

# ---------- render summary report --------------------------------------------
- name: "[troubleshooting] Render human-readable diagnostic summary"
  ansible.builtin.template:
    src: diag_report.txt.j2
    dest: "{{ troubleshooting_artifact_dir }}/diag_report.txt"
    mode: "0600"

# ---------- auto-restart gate ------------------------------------------------
- name: "[troubleshooting] Identify services that are NOT running"
  ansible.builtin.set_fact:
    troubleshooting_failed_services: >-
      {{ troubleshooting_services | select('defined') |
         select('ne', '') |
         list }}

- name: "[troubleshooting] Notify and trigger auto-restart handler"
  ansible.builtin.debug:
    msg: "Diagnostic complete â€” artifact dir: {{ troubleshooting_artifact_dir }}"
  notify:
    - troubleshooting_send_notification
    - troubleshooting_cleanup_old_artifacts
