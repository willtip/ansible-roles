---
# ---------------------------------------------------------------------------
# onetime / tasks / rollback.yml
# Include this file inside a `rescue:` block when onetime_rollback_on_failure
# is true and a rollback script is defined.
# ---------------------------------------------------------------------------

- name: "[onetime|rollback] Log rollback initiation"
  ansible.builtin.shell:
    cmd: |
      echo "[ROLLBACK-START] {{ ansible_date_time.iso8601 }} â€” operation={{ onetime_operation_id }}" >> {{ onetime_audit_log_file }}
  changed_when: true

- name: "[onetime|rollback] Upload rollback script"
  ansible.builtin.copy:
    src: "{{ onetime_rollback_script }}"
    dest: "{{ onetime_marker_dir }}/rollback_script.sh"
    mode: "0750"
    owner: root
  when: onetime_rollback_script | length > 0

- name: "[onetime|rollback] Execute rollback script"
  ansible.builtin.shell:
    cmd: |
      {{ onetime_marker_dir }}/rollback_script.sh \
        2>&1 | tee -a {{ onetime_audit_log_file }}
  register: onetime_rollback_result
  changed_when: true
  when: onetime_rollback_script | length > 0

- name: "[onetime|rollback] Remove the completion marker (if it was placed)"
  ansible.builtin.file:
    path: "{{ onetime_marker_file }}"
    state: absent

- name: "[onetime|rollback] Log rollback completion"
  ansible.builtin.shell:
    cmd: |
      echo "[ROLLBACK-DONE] {{ ansible_date_time.iso8601 }} rc={{ onetime_rollback_result.rc | default('N/A') }}" >> {{ onetime_audit_log_file }}
  changed_when: true

- name: "[onetime|rollback] Notify via Slack"
  ansible.builtin.debug:
    msg: "ROLLBACK for '{{ onetime_operation_id }}' completed."
  notify: onetime_notify_rollback
