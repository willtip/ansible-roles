---
# ---------------------------------------------------------------------------
# onetime / tasks / main.yml
# ---------------------------------------------------------------------------

- name: "[onetime] Abort if role is disabled"
  ansible.builtin.debug:
    msg: "One-time role is DISABLED. Skipping '{{ onetime_operation_id }}'."
  when: not onetime_enabled

# ======================================================================
# Derived facts
# ======================================================================
- name: "[onetime] Compute marker and log paths"
  ansible.builtin.set_fact:
    onetime_marker_file:    "{{ onetime_marker_dir }}/{{ onetime_operation_id }}.marker"
    onetime_audit_log_file: "{{ onetime_audit_log_dir }}/{{ onetime_operation_id }}.log"
  when: onetime_enabled

# ======================================================================
# Bootstrap directories
# ======================================================================
- name: "[onetime] Ensure marker directory exists"
  ansible.builtin.file:
    path: "{{ onetime_marker_dir }}"
    state: directory
    mode: "0750"
    owner: root
  when: onetime_enabled

- name: "[onetime] Ensure audit-log directory exists"
  ansible.builtin.file:
    path: "{{ onetime_audit_log_dir }}"
    state: directory
    mode: "0750"
    owner: root
  when: onetime_enabled

# ======================================================================
# 1 – Idempotency guard
# ======================================================================
- name: "[onetime] Check for existing completion marker"
  ansible.builtin.stat:
    path: "{{ onetime_marker_file }}"
  register: onetime_marker_stat
  when: onetime_enabled

- name: "[onetime] SKIP — operation already completed (marker exists)"
  ansible.builtin.debug:
    msg: >
      Operation '{{ onetime_operation_id }}' was already completed.
      Marker: {{ onetime_marker_file }}.  Use onetime_force=true to re-run.
  when: >
    onetime_enabled and
    onetime_marker_stat.stat.exists and
    not onetime_force

- name: "[onetime] End play for already-completed operations"
  ansible.builtin.meta: end_host
  when: >
    onetime_enabled and
    onetime_marker_stat.stat.exists and
    not onetime_force

# ======================================================================
# 2 – Preflight checks
# ======================================================================
- name: "[onetime] Run preflight checks"
  ansible.builtin.shell:
    cmd: "{{ item }}"
  register: onetime_preflight_results
  loop: "{{ onetime_preflight_checks }}"
  loop_control:
    loop_var: item
  changed_when: false
  when: onetime_enabled and onetime_preflight_checks | length > 0

- name: "[onetime] Fail if any preflight check failed"
  ansible.builtin.fail:
    msg: "Preflight check failed: {{ item.cmd }}"
  loop: "{{ onetime_preflight_results.results | default([]) }}"
  loop_control:
    loop_var: item
  when: >
    onetime_enabled and
    item.rc is defined and
    item.rc != 0

# ======================================================================
# 3 – Deploy wrapper script
# ======================================================================
- name: "[onetime] Copy the one-time wrapper script"
  ansible.builtin.copy:
    src: onetime_wrapper.sh
    dest: "{{ onetime_marker_dir }}/onetime_wrapper.sh"
    mode: "0750"
    owner: root
  when: onetime_enabled

# ======================================================================
# 4 – Execute the migration / setup script
# ======================================================================
- name: "[onetime] Log start of operation"
  ansible.builtin.shell:
    cmd: |
      echo "[START] {{ ansible_date_time.iso8601 }} — operation={{ onetime_operation_id }}" >> {{ onetime_audit_log_file }}
  changed_when: true
  when: onetime_enabled

- name: "[onetime] Upload migration script to target"
  ansible.builtin.copy:
    src: "{{ onetime_migration_script }}"
    dest: "{{ onetime_marker_dir }}/migration_script.sh"
    mode: "0750"
    owner: root
  when: onetime_enabled and onetime_migration_script | length > 0

- name: "[onetime] Execute the migration script"
  ansible.builtin.shell:
    cmd: |
      {{ onetime_marker_dir }}/migration_script.sh {{ onetime_migration_args }} \
        2>&1 | tee -a {{ onetime_audit_log_file }}
  register: onetime_migration_result
  changed_when: true
  when: onetime_enabled and onetime_migration_script | length > 0
  failed_when: onetime_migration_result.rc != 0

# ======================================================================
# 5 – Drop completion marker
# ======================================================================
- name: "[onetime] Write completion marker"
  ansible.builtin.copy:
    content: |
      operation_id: {{ onetime_operation_id }}
      completed_at: {{ ansible_date_time.iso8601 }}
      host: {{ inventory_hostname }}
      forced: {{ onetime_force }}
    dest: "{{ onetime_marker_file }}"
    mode: "0640"
    owner: root
  when: onetime_enabled

- name: "[onetime] Log completion"
  ansible.builtin.shell:
    cmd: |
      echo "[DONE] {{ ansible_date_time.iso8601 }} — operation={{ onetime_operation_id }} rc={{ onetime_migration_result.rc | default('N/A') }}" >> {{ onetime_audit_log_file }}
  changed_when: true
  when: onetime_enabled

# ======================================================================
# 6 – Render summary
# ======================================================================
- name: "[onetime] Render summary report"
  ansible.builtin.template:
    src: onetime_summary.txt.j2
    dest: "{{ onetime_audit_log_dir }}/{{ onetime_operation_id }}_summary.txt"
    mode: "0640"
  when: onetime_enabled

- name: "[onetime] Notify Slack — operation complete"
  ansible.builtin.debug:
    msg: "One-time operation '{{ onetime_operation_id }}' finished successfully."
  notify: onetime_notify_slack
  when: onetime_enabled

# ======================================================================
# 7 – Rescue (rollback)  — handled via a block in the calling playbook
#     or via the rescue block pattern below for self-contained use.
# ======================================================================
