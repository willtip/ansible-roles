---
# ---------------------------------------------------------------------------
# configuration / tasks / rsyslog.yml
# ---------------------------------------------------------------------------

- name: "[configuration|rsyslog] Install rsyslog"
  ansible.builtin.package:
    name: "{{ configuration_rsyslog_package }}"
    state: present
  notify: configuration_restart_rsyslog

- name: "[configuration|rsyslog] Backup current rsyslog remote config"
  ansible.builtin.copy:
    src: /etc/rsyslog.d/50-ansible-remote.conf
    dest: "{{ configuration_backup_dir }}/50-ansible-remote.conf.{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: "0600"
  when: configuration_backup_enabled
  failed_when: false

- name: "[configuration|rsyslog] Deploy remote-forward config"
  ansible.builtin.template:
    src: rsyslog_remote.conf.j2
    dest: /etc/rsyslog.d/50-ansible-remote.conf
    owner: root
    mode: "0644"
  notify: configuration_restart_rsyslog
  when: configuration_rsyslog_remote_host | length > 0

- name: "[configuration|rsyslog] Remove remote-forward config if host is empty"
  ansible.builtin.file:
    path: /etc/rsyslog.d/50-ansible-remote.conf
    state: absent
  notify: configuration_restart_rsyslog
  when: configuration_rsyslog_remote_host | length == 0

- name: "[configuration|rsyslog] Ensure rsyslog is enabled and running"
  ansible.builtin.service:
    name: "{{ configuration_rsyslog_service_name }}"
    state: started
    enabled: true
