---
# ---------------------------------------------------------------------------
# configuration / tasks / ntp.yml
# ---------------------------------------------------------------------------

- name: "[configuration|ntp] Backup current chrony.conf"
  ansible.builtin.copy:
    src: "{{ configuration_chrony_conf_path }}"
    dest: "{{ configuration_backup_dir }}/chrony.conf.{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: "0600"
  when: configuration_backup_enabled
  failed_when: false   # file may not yet exist on fresh hosts

- name: "[configuration|ntp] Install chrony package"
  ansible.builtin.package:
    name: "{{ configuration_ntp_package_map[ansible_os_family] }}"
    state: present
  notify: configuration_restart_chrony

- name: "[configuration|ntp] Set system timezone"
  ansible.builtin.timezone:
    name: "{{ configuration_ntp_timezone }}"

- name: "[configuration|ntp] Deploy chrony configuration"
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: "{{ configuration_chrony_conf_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: chronyd configcheck -f %s 2>/dev/null || true
  notify: configuration_restart_chrony

- name: "[configuration|ntp] Ensure chronyd is enabled and running"
  ansible.builtin.service:
    name: "{{ configuration_ntp_service_name }}"
    state: started
    enabled: true
