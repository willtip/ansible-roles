---
# ---------------------------------------------------------------------------
# operational / tasks / restart.yml
# ---------------------------------------------------------------------------

- name: "[operational|restart] Gracefully stop unhealthy service"
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
  loop: "{{ operational_unhealthy_services | default([]) }}"
  loop_control:
    loop_var: item
  when: operational_unhealthy_services | default([]) | length > 0

- name: "[operational|restart] Observe grace window"
  ansible.builtin.pause:
    seconds: "{{ operational_restart_grace_seconds }}"
  when: operational_unhealthy_services | default([]) | length > 0

- name: "[operational|restart] Restart unhealthy services"
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop: "{{ operational_unhealthy_services | default([]) }}"
  loop_control:
    loop_var: item
  when: operational_unhealthy_services | default([]) | length > 0
  notify: operational_notify_restart

- name: "[operational|restart] Wait for restarted services to become ready"
  ansible.builtin.service_facts:
  register: operational_post_restart_facts
  when: operational_unhealthy_services | default([]) | length > 0
