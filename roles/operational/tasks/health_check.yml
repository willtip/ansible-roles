---
# ---------------------------------------------------------------------------
# operational / tasks / health_check.yml
# ---------------------------------------------------------------------------

- name: "[operational|health] Check each monitored service"
  service_health_check:
    service_name: "{{ item }}"
    healthy_states: "{{ operational_healthy_states }}"
  register: operational_health_results
  loop: "{{ operational_services }}"
  loop_control:
    loop_var: item

- name: "[operational|health] Flag unhealthy services for restart"
  ansible.builtin.set_fact:
    operational_unhealthy_services: >-
      {{ operational_health_results.results
         | selectattr('healthy', 'equalto', false)
         | map(attribute='name')
         | list }}
