---
# ---------------------------------------------------------------------------
# operational / tasks / housekeeping.yml
# ---------------------------------------------------------------------------

- name: "[operational|hk] Find stale files in purge directories"
  ansible.builtin.find:
    paths: "{{ operational_purge_directories }}"
    age: "{{ operational_purge_max_age_days }}d"
    state: file
  register: operational_stale_files

- name: "[operational|hk] Remove stale files"
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ operational_stale_files.files }}"
  loop_control:
    loop_var: item

- name: "[operational|hk] Log housekeeping summary"
  ansible.builtin.shell:
    cmd: |
      echo "[{{ ansible_date_time.iso8601 }}] Purged {{ operational_stale_files.files | length }} file(s) from {{ operational_purge_directories | join(', ') }}" >> {{ operational_housekeeping_log }}
  changed_when: true
  when: operational_stale_files.files | length > 0
